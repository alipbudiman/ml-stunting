<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Stunting - Prediction Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input[type="text"], input[type="date"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        .iot-input {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .predict-btn {
            background-color: #28a745;
            font-size: 18px;
            padding: 15px 30px;
        }
        .predict-btn:hover {
            background-color: #218838;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.waiting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .data-display {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        .data-item {
            margin: 5px 0;
            font-family: monospace;
        }
        .logs {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .prediction-result {
            background-color: #f8f9fa;
            border: 2px solid #28a745;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .prediction-result.error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .result-item {
            margin: 10px 0;
            font-size: 16px;
        }
        .result-label {
            font-weight: bold;
            color: #333;
        }
        .result-value {
            color: #007bff;
            font-family: monospace;
        }
        .stunting-status {
            font-size: 20px;
            font-weight: bold;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            margin: 10px 0;
        }
        .stunting-status.normal {
            background-color: #d4edda;
            color: #155724;
        }
        .stunting-status.stunted {
            background-color: #f8d7da;
            color: #721c24;
        }
        .header-section {
            text-align: center;
            margin-bottom: 30px;
        }
        .connection-info {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .required {
            color: red;
        }
        .predict-section {
            text-align: center;
            margin-top: 30px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <h1>üè• ML Stunting - Prediction System</h1>
        <p>Sistem Prediksi Stunting dengan Data IoT Real-time</p>
    </div>

    <!-- Connection Setup -->
    <div class="container">
        <h2>üîó Connection Setup</h2>
        <div class="form-grid">
            <div class="input-group">
                <label for="serverUrl">Server URL:</label>
                <input type="text" id="serverUrl" value="localhost:5000">
            </div>
            <div class="input-group">
                <label for="deviceId">Device ID:</label>
                <input type="text" id="deviceId" value="IOT_001">
            </div>
        </div>
        <button onclick="connectToDevice()">Connect to IoT Device</button>
        <button onclick="disconnectFromDevice()" disabled id="disconnectBtn">Disconnect</button>
        
        <div id="connectionStatus" class="status disconnected">
            Status: Disconnected from IoT Device
        </div>
        
        <div class="connection-info">
            <strong>Info:</strong> Connect to IoT device to receive real-time weight (BB) and height (TB) data for prediction.
        </div>
    </div>

    <!-- Input Form -->
    <div class="container">
        <h2>üìù Child Data Input</h2>
        <form id="predictionForm">
            <div class="form-grid">
                <!-- User Input Fields -->
                <div>
                    <h3>üë§ Personal Information</h3>
                    <div class="input-group">
                        <label for="nama">Nama Anak <span class="required">*</span>:</label>
                        <input type="text" id="nama" placeholder="Masukkan nama anak" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="tanggalLahir">Tanggal Lahir <span class="required">*</span>:</label>
                        <input type="date" id="tanggalLahir" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="jenisKelamin">Jenis Kelamin <span class="required">*</span>:</label>
                        <select id="jenisKelamin" required>
                            <option value="">Pilih Jenis Kelamin</option>
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </div>
                </div>
                
                <!-- Birth Data -->
                <div>
                    <h3>üë∂ Birth Information</h3>
                    <div class="input-group">
                        <label for="bbLahir">Berat Badan Lahir (kg) <span class="required">*</span>:</label>
                        <input type="text" id="bbLahir" placeholder="contoh: 3.2" required>
                    </div>
                    
                    <div class="input-group">
                        <label for="tbLahir">Tinggi Badan Lahir (cm) <span class="required">*</span>:</label>
                        <input type="text" id="tbLahir" placeholder="contoh: 50" required>
                    </div>
                </div>
            </div>
            
            <!-- IoT Data Section -->
            <div>
                <h3>üì° IoT Device Data (Real-time)</h3>
                <div class="form-grid">
                    <div class="input-group">
                        <label for="beratCurrent">Berat Badan Saat Ini (kg) - IoT:</label>
                        <input type="text" id="beratCurrent" class="iot-input" disabled placeholder="Waiting for IoT data...">
                    </div>
                    
                    <div class="input-group">
                        <label for="tinggiCurrent">Tinggi Badan Saat Ini (cm) - IoT:</label>
                        <input type="text" id="tinggiCurrent" class="iot-input" disabled placeholder="Waiting for IoT data...">
                    </div>
                </div>
                
                <div class="data-display">
                    <h4>üìä Real-time IoT Data</h4>
                    <div class="data-item">Device ID: <span id="displayDeviceId">-</span></div>
                    <div class="data-item">Current Weight: <span id="displayWeight">-</span> kg</div>
                    <div class="data-item">Current Height: <span id="displayHeight">-</span> cm</div>
                    <div class="data-item">Status: <span id="displayStatus">-</span></div>
                    <div class="data-item">Last Updated: <span id="displayTimestamp">-</span></div>
                </div>
            </div>
            
            <!-- Predict Button -->
            <div class="predict-section">
                <button type="button" class="predict-btn" id="predictBtn" disabled onclick="predictStunting()">
                    üîÆ Predict Stunting Status
                </button>
            </div>
        </form>
    </div>

    <!-- Prediction Result -->
    <div class="container hidden" id="resultContainer">
        <h2>üìä Prediction Result</h2>
        <div id="predictionResult"></div>
    </div>

    <!-- Logs -->
    <div class="container">
        <h2>üìã System Logs</h2>
        <div id="logs" class="logs"></div>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <script>
        let websocket = null;
        let isConnected = false;
        let iotDataReceived = false;

        function log(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusDiv = document.getElementById('connectionStatus');
            const disconnectBtn = document.getElementById('disconnectBtn');
            
            if (connected) {
                statusDiv.textContent = 'Status: Connected to IoT Device';
                statusDiv.className = 'status connected';
                disconnectBtn.disabled = false;
            } else {
                statusDiv.textContent = 'Status: Disconnected from IoT Device';
                statusDiv.className = 'status disconnected';
                disconnectBtn.disabled = true;
                iotDataReceived = false;
                updatePredictButton();
            }
        }

        function updateIotDisplay(data) {
            document.getElementById('displayDeviceId').textContent = data.did || '-';
            document.getElementById('displayWeight').textContent = data.bb || '-';
            document.getElementById('displayHeight').textContent = data.tb || '-';
            document.getElementById('displayStatus').textContent = data.status || '-';
            
            if (data.timestamp) {
                const date = new Date(data.timestamp * 1000);
                document.getElementById('displayTimestamp').textContent = date.toLocaleString();
            } else {
                document.getElementById('displayTimestamp').textContent = '-';
            }

            // Update form inputs
            if (data.bb && data.tb && data.status === 'updated') {
                document.getElementById('beratCurrent').value = data.bb;
                document.getElementById('tinggiCurrent').value = data.tb;
                iotDataReceived = true;
                log(`‚úÖ IoT data received: BB=${data.bb}kg, TB=${data.tb}cm`);
            } else {
                document.getElementById('beratCurrent').value = '';
                document.getElementById('tinggiCurrent').value = '';
                iotDataReceived = false;
            }
            
            updatePredictButton();
        }

        function updatePredictButton() {
            const predictBtn = document.getElementById('predictBtn');
            const nama = document.getElementById('nama').value.trim();
            const tanggalLahir = document.getElementById('tanggalLahir').value;
            const jenisKelamin = document.getElementById('jenisKelamin').value;
            const bbLahir = document.getElementById('bbLahir').value.trim();
            const tbLahir = document.getElementById('tbLahir').value.trim();
            
            const allUserDataFilled = nama && tanggalLahir && jenisKelamin && bbLahir && tbLahir;
            
            if (allUserDataFilled && iotDataReceived) {
                predictBtn.disabled = false;
                predictBtn.textContent = 'üîÆ Predict Stunting Status';
                predictBtn.className = 'predict-btn';
            } else {
                predictBtn.disabled = true;
                if (!allUserDataFilled) {
                    predictBtn.textContent = '‚ö†Ô∏è Complete Personal Data Required';
                } else if (!iotDataReceived) {
                    predictBtn.textContent = '‚è≥ Waiting for IoT Data...';
                }
            }
        }

        function connectToDevice() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            const deviceId = document.getElementById('deviceId').value.trim();
            
            if (!serverUrl || !deviceId) {
                alert('Please enter Server URL and Device ID');
                return;
            }
            
            if (websocket) {
                websocket.close();
            }
            
            const wsProtocol = serverUrl.startsWith('https') ? 'wss' : 'ws';
            const cleanUrl = serverUrl.replace(/^https?:\/\//, '');
            const wsUrl = `${wsProtocol}://${cleanUrl}/ws/data/${deviceId}`;
            
            log(`üîå Connecting to: ${wsUrl}`);
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                log(`‚úÖ Connected to device: ${deviceId}`);
                updateConnectionStatus(true);
            };
            
            websocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    log(`üì° Received: ${JSON.stringify(data)}`);
                    updateIotDisplay(data);
                } catch (e) {
                    log(`‚ùå Error parsing data: ${e.message}`);
                }
            };
            
            websocket.onclose = function(event) {
                log(`üîå Connection closed (Code: ${event.code})`);
                updateConnectionStatus(false);
                websocket = null;
            };
            
            websocket.onerror = function(error) {
                log(`‚ùå WebSocket error: ${error}`);
                updateConnectionStatus(false);
            };
        }

        function disconnectFromDevice() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            updateConnectionStatus(false);
            log('üîå Manually disconnected');
        }

        function formatDateForAPI(dateString) {
            // Convert YYYY-MM-DD to YYYY-MM-DD format (already in correct format)
            return dateString;
        }

        async function predictStunting() {
            const serverUrl = document.getElementById('serverUrl').value.trim();
            const nama = document.getElementById('nama').value.trim();
            const tanggalLahir = document.getElementById('tanggalLahir').value;
            const jenisKelamin = document.getElementById('jenisKelamin').value;
            const bbLahir = parseFloat(document.getElementById('bbLahir').value);
            const tbLahir = parseFloat(document.getElementById('tbLahir').value);
            const beratCurrent = parseFloat(document.getElementById('beratCurrent').value);
            const tinggiCurrent = parseFloat(document.getElementById('tinggiCurrent').value);

            if (!serverUrl) {
                alert('Please enter Server URL');
                return;
            }

            // Validation
            if (!nama || !tanggalLahir || !jenisKelamin || isNaN(bbLahir) || isNaN(tbLahir) || isNaN(beratCurrent) || isNaN(tinggiCurrent)) {
                alert('Please fill all required fields with valid data');
                return;
            }

            try {
                log(`üîÆ Starting prediction for: ${nama}`);
                
                const httpProtocol = serverUrl.startsWith('localhost') || serverUrl.startsWith('127.0.0.1') ? 'http' : 'https';
                const cleanUrl = serverUrl.replace(/^https?:\/\//, '');
                const apiUrl = `${httpProtocol}://${cleanUrl}/predict`;
                
                const requestData = {
                    nama: nama,
                    tanggal_lahir: formatDateForAPI(tanggalLahir),
                    jenis_kelamin: jenisKelamin,
                    bb_lahir: bbLahir,
                    tb_lahir: tbLahir,
                    berat: beratCurrent,
                    tinggi: tinggiCurrent
                };

                log(`üì§ Sending prediction request: ${JSON.stringify(requestData)}`);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (response.ok) {
                    log(`‚úÖ Prediction successful!`);
                    displayPredictionResult(result, requestData);
                } else {
                    log(`‚ùå Prediction failed (${response.status}): ${result.detail || result.message}`);
                    displayPredictionError(result);
                }
            } catch (error) {
                log(`‚ùå Prediction error: ${error.message}`);
                displayPredictionError({ detail: error.message });
            }
        }

        function displayPredictionResult(result, inputData) {
            const resultContainer = document.getElementById('resultContainer');
            const predictionResult = document.getElementById('predictionResult');
            
            const data = result.data;
            const message = result.message;

            // Extract the actual prediction results from API response
            const tbu = data.tbu || 'Unknown';  // Status Tinggi Badan menurut Umur
            const bbu = data.bbu || 'Unknown';  // Status Berat Badan menurut Umur
            const bbtb = data.bbtb || 'Unknown'; // Status Berat Badan menurut Tinggi Badan

            // Determine if any status indicates stunting risk
            const isStunted = tbu.toLowerCase().includes('pendek') || 
                              bbu.toLowerCase().includes('kurang') || 
                              bbtb.toLowerCase().includes('kurang');

            predictionResult.innerHTML = `
                <div class="stunting-status ${isStunted ? 'stunted' : 'normal'}">
                    ${isStunted ? '‚ö†Ô∏è PERLU PERHATIAN' : '‚úÖ STATUS NORMAL'}
                </div>
                
                <div class="result-item">
                    <span class="result-label">Nama Anak:</span>
                    <span class="result-value">${inputData.nama}</span>
                </div>
                
                <div class="result-item">
                    <span class="result-label">Tanggal Lahir:</span>
                    <span class="result-value">${inputData.tanggal_lahir}</span>
                </div>
                
                <div class="result-item">
                    <span class="result-label">Jenis Kelamin:</span>
                    <span class="result-value">${inputData.jenis_kelamin === 'L' ? 'Laki-laki' : 'Perempuan'}</span>
                </div>

                <div style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                    <h3 style="margin-top: 0; color: #007bff;">üìä Hasil Analisis Status Gizi</h3>
                    
                    <div class="result-item">
                        <span class="result-label">Status Tinggi Badan menurut Umur (TB/U):</span>
                        <span class="result-value" style="font-weight: bold; color: ${tbu.toLowerCase().includes('pendek') ? '#dc3545' : '#28a745'};">${tbu}</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">Status Berat Badan menurut Umur (BB/U):</span>
                        <span class="result-value" style="font-weight: bold; color: ${bbu.toLowerCase().includes('kurang') ? '#dc3545' : bbu.toLowerCase().includes('lebih') ? '#ffc107' : '#28a745'};">${bbu}</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">Status Berat Badan menurut Tinggi Badan (BB/TB):</span>
                        <span class="result-value" style="font-weight: bold; color: ${bbtb.toLowerCase().includes('kurang') ? '#dc3545' : bbtb.toLowerCase().includes('lebih') ? '#ffc107' : '#28a745'};">${bbtb}</span>
                    </div>
                </div>

                <div style="margin: 20px 0; padding: 15px; background-color: #e9ecef; border-radius: 8px;">
                    <h3 style="margin-top: 0; color: #495057;">üìè Data Pengukuran</h3>
                    
                    <div class="result-item">
                        <span class="result-label">Berat Badan Saat Ini:</span>
                        <span class="result-value">${inputData.berat} kg</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">Tinggi Badan Saat Ini:</span>
                        <span class="result-value">${inputData.tinggi} cm</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">Berat Badan Lahir:</span>
                        <span class="result-value">${inputData.bb_lahir} kg</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">Tinggi Badan Lahir:</span>
                        <span class="result-value">${inputData.tb_lahir} cm</span>
                    </div>
                </div>
                
                <div class="result-item">
                    <span class="result-label">Pesan Sistem:</span>
                    <span class="result-value">${message}</span>
                </div>
                
                <div class="result-item">
                    <span class="result-label">Waktu Prediksi:</span>
                    <span class="result-value">${new Date().toLocaleString()}</span>
                </div>
            `;
            
            predictionResult.className = 'prediction-result';
            resultContainer.classList.remove('hidden');
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function displayPredictionError(error) {
            const resultContainer = document.getElementById('resultContainer');
            const predictionResult = document.getElementById('predictionResult');
            
            predictionResult.innerHTML = `
                <div class="stunting-status stunted">
                    ‚ùå PREDICTION ERROR
                </div>
                
                <div class="result-item">
                    <span class="result-label">Error Message:</span>
                    <span class="result-value">${error.detail || error.message || 'Unknown error'}</span>
                </div>
                
                <div class="result-item">
                    <span class="result-label">Error Time:</span>
                    <span class="result-value">${new Date().toLocaleString()}</span>
                </div>
            `;
            
            predictionResult.className = 'prediction-result error';
            resultContainer.classList.remove('hidden');
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Event listeners for form validation
        document.addEventListener('DOMContentLoaded', function() {
            const formInputs = ['nama', 'tanggalLahir', 'jenisKelamin', 'bbLahir', 'tbLahir'];
            
            formInputs.forEach(inputId => {
                document.getElementById(inputId).addEventListener('input', updatePredictButton);
                document.getElementById(inputId).addEventListener('change', updatePredictButton);
            });
            
            // Initialize
            updateConnectionStatus(false);
            updatePredictButton();
            log('üöÄ ML Stunting Prediction System initialized');
        });
    </script>
</body>
</html>
